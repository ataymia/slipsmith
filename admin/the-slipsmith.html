<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE Slipsmith - Admin Tool</title>
    <style>
        /* Root Variables - Dark Theme with Money Green */
        :root {
            --bg-primary: #0a0e0f;
            --bg-secondary: #131a1d;
            --bg-tertiary: #1a2528;
            --bg-card: #1f2a2e;
            
            --text-primary: #e8f0f2;
            --text-secondary: #a8b8bd;
            --text-muted: #6b7e85;
            
            --accent-green: #00ff88;
            --accent-green-dark: #00cc6d;
            --accent-green-light: #4dffaa;
            --accent-mint: #66ffcc;
            
            --danger: #ff4444;
            --warning: #ffaa00;
            --info: #44aaff;
            --success: #00ff88;
            
            --border-color: #2a3a40;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        /* Print-specific styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            .controls, .tabs, button, .no-print {
                display: none !important;
            }
            .slip-container, .recap-container {
                page-break-after: always;
                background: white;
                color: black;
            }
            .slip-header {
                background: #1a2528 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent-green);
        }

        .header h1 {
            color: var(--accent-green);
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            border-radius: 8px 8px 0 0;
        }

        .tab-btn:hover {
            color: var(--accent-green-light);
            background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 136, 0.05) 100%);
        }

        .tab-btn.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
            background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 136, 0.1) 100%);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .control-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        button {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-mint) 100%);
            color: var(--bg-primary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
        }

        button:hover {
            background: linear-gradient(135deg, var(--accent-green-light) 0%, var(--accent-green) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.btn-secondary {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        button.btn-secondary:hover {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.15);
        }

        .slip-container {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }

        .slip-header {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--accent-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px rgba(0, 255, 136, 0.15);
        }

        .slip-header-content {
            flex: 1;
        }

        .slip-branding {
            text-align: right;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-green);
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .slip-title {
            font-size: 1.3rem;
            color: var(--accent-green);
            margin-bottom: 0.3rem;
        }

        .slip-meta {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .event-group {
            margin-bottom: 2rem;
        }

        .sport-header {
            font-size: 1.2rem;
            color: var(--accent-mint);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .event-card {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(26, 37, 40, 0.8) 100%);
            padding: 1.25rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-green);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .event-card:hover {
            transform: translateX(4px);
            box-shadow: 0 6px 16px rgba(0, 255, 136, 0.2);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .game-info {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .event-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .tier-badge-inline {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .tier-starter {
            background: #4db8ff;
            color: white;
        }
        
        .tier-pro {
            background: #00ff88;
            color: var(--bg-primary);
        }
        
        .tier-vip {
            background: #ffaa00;
            color: var(--bg-primary);
        }

        .pick-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .pick-item {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .pick-label {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-bottom: 0.15rem;
        }

        .pick-value {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .pick-line {
            color: var(--accent-green);
            font-size: 1rem;
            font-weight: bold;
        }
        
        .pick-probability {
            color: var(--accent-mint);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        
        .pick-reasoning {
            background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(10, 14, 15, 0.8) 100%);
            padding: 0.75rem;
            border-radius: 10px;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            border-left: 3px solid var(--accent-mint);
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .badge-hit {
            background: var(--success);
            color: var(--bg-primary);
        }

        .badge-miss {
            background: var(--danger);
            color: white;
        }

        .badge-push {
            background: var(--warning);
            color: var(--bg-primary);
        }

        .badge-void {
            background: var(--text-muted);
            color: white;
        }

        .badge-pending {
            background: var(--info);
            color: white;
        }

        .result-info {
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(10, 14, 15, 0.8) 100%);
            border-radius: 12px;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent-mint);
        }

        .result-actual {
            color: var(--accent-green);
            font-weight: 600;
        }

        .result-reason {
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 0.5rem;
        }

        .error-message {
            background: linear-gradient(135deg, var(--danger) 0%, #cc3333 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
        }

        .success-message {
            background: linear-gradient(135deg, var(--success) 0%, var(--accent-green-light) 100%);
            color: var(--bg-primary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .recap-container {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }

        .recap-summary {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-green);
        }

        .sample-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ THE Slipsmith</h1>
        <p>Morning Slip Renderer & Results Bot Grading Tool</p>
    </div>

    <div class="tabs no-print">
        <button class="tab-btn active" data-tab="generate">Generate</button>
        <button class="tab-btn" data-tab="results">Results</button>
        <button class="tab-btn" data-tab="recap">Recap</button>
    </div>

    <!-- Generate Tab -->
    <div id="generate-tab" class="tab-content active">
        <div class="controls">
            <h3 style="color: var(--accent-green); margin-bottom: 1rem;">üìù Slip JSON Input</h3>
            
            <div class="control-row">
                <label style="color: var(--text-primary); font-weight: 600;">
                    Tier Level:
                    <select id="tier-select" style="margin-left: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                        <option value="starter">Starter (5-7 picks)</option>
                        <option value="pro">Pro (15-20 picks)</option>
                        <option value="vip" selected>VIP (30+ picks)</option>
                    </select>
                </label>
            </div>
            
            <div class="control-row sample-buttons">
                <button onclick="loadSampleNBA()">Load NBA Sample</button>
                <button onclick="loadSampleNHL()">Load NHL Sample</button>
                <button onclick="loadSampleNFL()">Load NFL Sample</button>
                <button onclick="loadSampleSoccer()">Load Soccer Sample</button>
                <button class="btn-secondary" onclick="loadFromStorage()">Load from Storage</button>
            </div>
            <div style="margin-top: 1rem;">
                <textarea id="slip-json" placeholder='Paste your Slip JSON here...'></textarea>
            </div>
            <div class="control-row" style="margin-top: 1rem;">
                <button onclick="renderSlip()">üé® Render Slip</button>
                <button onclick="postToFeed()" id="post-to-feed-btn" style="display: none;">üì§ Post to Feed</button>
                <button onclick="generateImage()">üì∏ Generate Image</button>
                <button onclick="saveToStorage()">üíæ Save to Storage</button>
                <button onclick="exportJSON()">‚¨áÔ∏è Download JSON</button>
                <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
            </div>
        </div>

        <div id="slip-output"></div>
    </div>

    <!-- Results Tab -->
    <div id="results-tab" class="tab-content">
        <div class="controls">
            <h3 style="color: var(--accent-green); margin-bottom: 1rem;">üìä Grade Picks with Live Stats</h3>
            <div class="control-row sample-buttons">
                <button onclick="loadSampleNBA()">Load NBA Sample</button>
                <button onclick="loadSampleNHL()">Load NHL Sample</button>
                <button onclick="loadSampleNFL()">Load NFL Sample</button>
                <button onclick="loadSampleSoccer()">Load Soccer Sample</button>
                <button class="btn-secondary" onclick="loadFromStorage()">Load from Storage</button>
            </div>
            <div style="margin-top: 1rem;">
                <textarea id="results-json" placeholder='Paste your Slip JSON here...'></textarea>
            </div>
            <div class="control-row" style="margin-top: 1rem;">
                <button onclick="gradeSlip()">üîç Grade Picks</button>
                <button onclick="exportGradedJSON()">‚¨áÔ∏è Download Graded JSON</button>
            </div>
        </div>

        <div id="results-output"></div>
    </div>

    <!-- Recap Tab -->
    <div id="recap-tab" class="tab-content">
        <div class="controls">
            <h3 style="color: var(--accent-green); margin-bottom: 1rem;">üìã Recap Sheets</h3>
            <div class="control-row sample-buttons">
                <button onclick="loadSampleGraded()">Load Sample Graded JSON</button>
                <button class="btn-secondary" onclick="loadFromStorage()">Load from Storage</button>
            </div>
            <div style="margin-top: 1rem;">
                <textarea id="recap-json" placeholder='Paste your Graded Slip JSON here (with results)...'></textarea>
            </div>
            <div class="control-row" style="margin-top: 1rem;">
                <button onclick="renderRecap()">üìä Render Recap</button>
                <button onclick="postRecapToFeed()" id="post-recap-to-feed-btn" style="display: none;">üì§ Post to Feed</button>
                <button onclick="generateRecapImage()">üì∏ Generate Image</button>
                <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
            </div>
        </div>

        <div id="recap-output"></div>
    </div>

    <!-- Post to Feed Modal -->
    <div id="post-to-feed-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: var(--accent-green); margin: 0;">üì§ Post to Content Feed</h2>
                <button onclick="closePostModal()" style="background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0; width: 32px; height: 32px; border-radius: 8px; transition: all 0.3s ease;">&times;</button>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Post Title *</label>
                <input type="text" id="feed-post-title" placeholder="e.g., NBA Morning Slip - Jan 15" style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Description (optional)</label>
                <textarea id="feed-post-description" rows="3" placeholder="Add a brief description or note..." style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 0.95rem; resize: vertical;"></textarea>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Who can see this? *</label>
                <select id="feed-post-tier" style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 1rem; cursor: pointer;">
                    <option value="starter">üîµ Starter (All Members)</option>
                    <option value="pro">üü° Pro & VIP Only</option>
                    <option value="vip">üíö VIP Exclusive</option>
                </select>
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">Choose which subscription tiers can view this slip</small>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button onclick="confirmPostToFeed()" id="confirm-post-btn" style="flex: 1; background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-mint) 100%); color: var(--bg-primary); border: none; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);">
                    Post to Feed
                </button>
                <button onclick="closePostModal()" style="flex: 1; background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); color: var(--text-primary); border: 1px solid var(--border-color); padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Cancel
                </button>
            </div>
            
            <div id="post-modal-status" style="margin-top: 1rem; display: none;"></div>
        </div>
    </div>

    <!-- html2canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDKs (v9 compat) - Must be loaded before firebase.js -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    
    <!-- Firebase initialization and app logic -->
    <script src="../firebase.js"></script>
    <script src="../app.js"></script>
    
    <script>
        // Global state and cache
        const apiCache = {
            nba: new Map(),
            nhl: new Map(),
            nfl: new Map(),
            soccer: new Map()
        };

        let currentSlipData = null;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // Sample JSON data
        const samples = {
            nba: {
                "slip_id": "NBA_2024_01_15",
                "date": "2024-01-15",
                "sport": "NBA",
                "tier": "vip",
                "events": [
                    {
                        "event_id": "nba_lakers_warriors_20240115",
                        "game_id": "LAL@GSW",
                        "time": "10:00 PM ET",
                        "player": "Stephen Curry",
                        "team": "GSW",
                        "market": "points",
                        "line": 27.5,
                        "direction": "over",
                        "probability": "75%",
                        "reasoning": "Curry averaging 30+ PPG in last 5 games vs LAL"
                    },
                    {
                        "event_id": "nba_lakers_warriors_20240115_2",
                        "game_id": "LAL@GSW",
                        "time": "10:00 PM ET",
                        "player": "LeBron James",
                        "team": "LAL",
                        "market": "assists",
                        "line": 7.5,
                        "direction": "over",
                        "probability": "68%",
                        "reasoning": "LeBron has been in playmaker mode, 9+ assists in 3 of last 4"
                    },
                    {
                        "event_id": "nba_celtics_bucks_20240115",
                        "game_id": "BOS@MIL",
                        "time": "8:00 PM ET",
                        "player": "Giannis Antetokounmpo",
                        "team": "MIL",
                        "market": "rebounds",
                        "line": 11.5,
                        "direction": "over",
                        "probability": "82%",
                        "reasoning": "Giannis dominates the boards vs Boston, 13+ rebounds in last 6 matchups"
                    }
                ]
            },
            nhl: {
                "slip_id": "NHL_2024_01_15",
                "date": "2024-01-15",
                "sport": "NHL",
                "tier": "pro",
                "events": [
                    {
                        "event_id": "nhl_leafs_bruins_20240115",
                        "game_id": "TOR@BOS",
                        "time": "7:00 PM ET",
                        "player": "Auston Matthews",
                        "team": "TOR",
                        "market": "goals",
                        "line": 0.5,
                        "direction": "over",
                        "probability": "65%",
                        "reasoning": "Matthews scored in 4 of last 5 games vs BOS"
                    },
                    {
                        "event_id": "nhl_oilers_flames_20240115",
                        "game_id": "EDM@CGY",
                        "time": "9:00 PM ET",
                        "player": "Connor McDavid",
                        "team": "EDM",
                        "market": "assists",
                        "line": 1.5,
                        "direction": "over",
                        "probability": "78%",
                        "reasoning": "McDavid has 2+ assists in last 7 games"
                    }
                ]
            },
            nfl: {
                "slip_id": "NFL_2024_01_14",
                "date": "2024-01-14",
                "sport": "NFL",
                "tier": "starter",
                "events": [
                    {
                        "event_id": "nfl_chiefs_bills_20240114",
                        "game_id": "KC@BUF",
                        "time": "6:30 PM ET",
                        "player": "Patrick Mahomes",
                        "team": "KC",
                        "market": "passing_yards",
                        "line": 275.5,
                        "direction": "over",
                        "probability": "71%",
                        "reasoning": "Buffalo defense allows 290+ yards per game to elite QBs"
                    },
                    {
                        "event_id": "nfl_49ers_packers_20240114",
                        "game_id": "SF@GB",
                        "time": "8:15 PM ET",
                        "player": "Christian McCaffrey",
                        "team": "SF",
                        "market": "rushing_yards",
                        "line": 85.5,
                        "direction": "over",
                        "probability": "80%",
                        "reasoning": "CMC has 100+ rushing yards in 5 straight playoff games"
                    }
                ]
            },
            soccer: {
                "slip_id": "SOCCER_2024_01_15",
                "date": "2024-01-15",
                "sport": "Soccer",
                "league": "EPL",
                "tier": "vip",
                "events": [
                    {
                        "event_id": "epl_arsenal_liverpool_20240115",
                        "game_id": "Arsenal@Liverpool",
                        "time": "3:00 PM ET",
                        "player": "Mohamed Salah",
                        "team": "Liverpool",
                        "market": "goals",
                        "line": 0.5,
                        "direction": "over",
                        "probability": "60%",
                        "reasoning": "Salah scored in 3 of last 4 vs Arsenal"
                    },
                    {
                        "event_id": "epl_mancity_chelsea_20240115",
                        "game_id": "Man City@Chelsea",
                        "time": "5:30 PM ET",
                        "player": "Erling Haaland",
                        "team": "Man City",
                        "market": "goals",
                        "line": 0.5,
                        "direction": "over",
                        "probability": "73%",
                        "reasoning": "Haaland has scored in every game vs Chelsea since joining City"
                    }
                ]
            }
        };

        // Load sample functions
        function loadSampleNBA() {
            document.getElementById('slip-json').value = JSON.stringify(samples.nba, null, 2);
            document.getElementById('results-json').value = JSON.stringify(samples.nba, null, 2);
        }

        function loadSampleNHL() {
            document.getElementById('slip-json').value = JSON.stringify(samples.nhl, null, 2);
            document.getElementById('results-json').value = JSON.stringify(samples.nhl, null, 2);
        }

        function loadSampleNFL() {
            document.getElementById('slip-json').value = JSON.stringify(samples.nfl, null, 2);
            document.getElementById('results-json').value = JSON.stringify(samples.nfl, null, 2);
        }

        function loadSampleSoccer() {
            document.getElementById('slip-json').value = JSON.stringify(samples.soccer, null, 2);
            document.getElementById('results-json').value = JSON.stringify(samples.soccer, null, 2);
        }

        function loadSampleGraded() {
            const graded = {
                ...samples.nba,
                events: samples.nba.events.map((ev, idx) => ({
                    ...ev,
                    tier: 'vip',
                    result: idx === 0 ? 'HIT' : idx === 1 ? 'MISS' : 'HIT',
                    actual_value: idx === 0 ? 32 : idx === 1 ? 6 : 13,
                    reason: idx === 0 ? 'Curry finished with 32 points on 11-20 shooting' : idx === 1 ? 'LeBron only recorded 6 assists in blowout win' : 'Giannis dominated with 13 rebounds'
                }))
            };
            document.getElementById('recap-json').value = JSON.stringify(graded, null, 2);
        }

        // Storage functions
        function saveToStorage() {
            const json = document.getElementById('slip-json').value;
            try {
                JSON.parse(json);
                localStorage.setItem('slipsmith_last_json', json);
                showMessage('success', 'Saved to browser storage!');
            } catch (e) {
                showMessage('error', 'Invalid JSON: ' + e.message);
            }
        }

        function loadFromStorage() {
            const json = localStorage.getItem('slipsmith_last_json');
            if (json) {
                document.getElementById('slip-json').value = json;
                document.getElementById('results-json').value = json;
                document.getElementById('recap-json').value = json;
                showMessage('success', 'Loaded from storage!');
            } else {
                showMessage('error', 'No saved data found');
            }
        }

        function exportJSON() {
            const json = document.getElementById('slip-json').value;
            try {
                JSON.parse(json);
                downloadJSON(json, 'slip.json');
            } catch (e) {
                showMessage('error', 'Invalid JSON: ' + e.message);
            }
        }

        function exportGradedJSON() {
            if (currentSlipData) {
                downloadJSON(JSON.stringify(currentSlipData, null, 2), 'graded-slip.json');
            } else {
                showMessage('error', 'Grade picks first!');
            }
        }

        function downloadJSON(content, filename) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Render slip (Generate tab)
        function renderSlip() {
            const json = document.getElementById('slip-json').value;
            const output = document.getElementById('slip-output');
            const selectedTier = document.getElementById('tier-select').value;
            
            try {
                const slip = JSON.parse(json);
                
                // Apply tier limits
                const tierLimits = {
                    'starter': 7,
                    'pro': 20,
                    'vip': 999
                };
                
                const maxPicks = tierLimits[selectedTier];
                let events = slip.events;
                let limitWarning = '';
                
                if (events.length > maxPicks) {
                    events = events.slice(0, maxPicks);
                    limitWarning = `<div class="error-message">‚ö†Ô∏è Only showing first ${maxPicks} picks due to ${selectedTier.toUpperCase()} tier limit</div>`;
                }
                
                // Add tier to slip and events
                slip.tier = selectedTier;
                events = events.map(ev => ({...ev, tier: selectedTier}));
                
                currentSlipData = {...slip, events};
                
                // Group events by sport or game
                const eventsBySport = {};
                events.forEach(ev => {
                    const sport = slip.sport || 'Unknown';
                    if (!eventsBySport[sport]) {
                        eventsBySport[sport] = [];
                    }
                    eventsBySport[sport].push(ev);
                });

                let html = limitWarning + `
                    <div class="slip-container" id="slip-to-capture">
                        <div class="slip-header">
                            <div class="slip-header-content">
                                <div class="slip-title">${slip.slip_id || 'Untitled Slip'}</div>
                                <div class="slip-meta">
                                    üìÖ ${slip.date || 'No date'} | 
                                    üèÄ ${slip.sport || 'Multi-Sport'} | 
                                    üìä ${events.length} Pick${events.length !== 1 ? 's' : ''}
                                </div>
                            </div>
                            <div class="slip-branding">$lip$mith</div>
                        </div>
                `;

                Object.keys(eventsBySport).forEach(sport => {
                    html += `<div class="event-group">
                        <div class="sport-header">${sport}</div>`;
                    
                    eventsBySport[sport].forEach(ev => {
                        html += renderEventCard(ev);
                    });
                    
                    html += `</div>`;
                });

                html += `</div>`;
                output.innerHTML = html;
                showMessage('success', 'Slip rendered successfully!');
                updatePostToFeedButton();
            } catch (e) {
                output.innerHTML = `<div class="error-message">‚ùå Error: ${e.message}</div>`;
                updatePostToFeedButton();
            }
        }

        function renderEventCard(event) {
            const tierBadge = event.tier ? `<span class="tier-badge-inline tier-${event.tier}">${event.tier.toUpperCase()}</span>` : '';
            const probability = event.probability ? `<div class="pick-probability">üéØ ${event.probability}</div>` : '';
            const reasoning = event.reasoning ? `<div class="pick-reasoning">üí° ${event.reasoning}</div>` : '';
            
            return `
                <div class="event-card">
                    <div class="event-header">
                        <div class="game-info">üèüÔ∏è ${event.game_id || 'N/A'}${tierBadge}</div>
                        <div class="event-time">‚è∞ ${event.time || 'TBD'}</div>
                    </div>
                    <div class="pick-details">
                        <div class="pick-item">
                            <div class="pick-label">Player</div>
                            <div class="pick-value">${event.player || 'N/A'}</div>
                        </div>
                        <div class="pick-item">
                            <div class="pick-label">Team</div>
                            <div class="pick-value">${event.team || 'N/A'}</div>
                        </div>
                        <div class="pick-item">
                            <div class="pick-label">Market</div>
                            <div class="pick-value">${formatMarket(event.market)}</div>
                        </div>
                        <div class="pick-item">
                            <div class="pick-label">Pick</div>
                            <div class="pick-line">${event.direction?.toUpperCase() || 'N/A'} ${event.line || 'N/A'}</div>
                            ${probability}
                        </div>
                    </div>
                    ${reasoning}
                </div>
            `;
        }

        function formatMarket(market) {
            if (!market) return 'N/A';
            return market.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Grade picks (Results tab)
        async function gradeSlip() {
            const json = document.getElementById('results-json').value;
            const output = document.getElementById('results-output');
            
            try {
                const slip = JSON.parse(json);
                output.innerHTML = '<div class="loading">Grading picks, fetching live stats</div>';
                
                // Grade each event
                const gradedEvents = [];
                for (const event of slip.events) {
                    const gradedEvent = await gradeEvent(event, slip.sport, slip.date);
                    gradedEvents.push(gradedEvent);
                }
                
                slip.events = gradedEvents;
                currentSlipData = slip;
                
                // Render graded results
                renderGradedResults(slip);
                
            } catch (e) {
                output.innerHTML = `<div class="error-message">‚ùå Error: ${e.message}</div>`;
            }
        }

        async function gradeEvent(event, sport, date) {
            const graded = { ...event };
            
            try {
                let stats;
                
                switch (sport?.toUpperCase()) {
                    case 'NBA':
                        stats = await fetchNBAStats(event, date);
                        break;
                    case 'NHL':
                        stats = await fetchNHLStats(event, date);
                        break;
                    case 'NFL':
                        stats = await fetchNFLStats(event, date);
                        break;
                    case 'SOCCER':
                        stats = await fetchSoccerStats(event, date);
                        break;
                    default:
                        graded.result = 'VOID';
                        graded.reason = `Unsupported sport: ${sport}`;
                        return graded;
                }
                
                if (stats.error) {
                    graded.result = 'PENDING';
                    graded.reason = stats.error;
                    return graded;
                }
                
                graded.actual_value = stats.value;
                graded.result = determineResult(event.direction, event.line, stats.value);
                graded.reason = stats.reason || `Player ${stats.value} ${event.market}`;
                
            } catch (e) {
                graded.result = 'PENDING';
                graded.reason = `Error: ${e.message}`;
            }
            
            return graded;
        }

        function determineResult(direction, line, actual) {
            if (actual === null || actual === undefined) {
                return 'VOID';
            }
            
            const lineNum = parseFloat(line);
            const actualNum = parseFloat(actual);
            
            if (isNaN(lineNum) || isNaN(actualNum)) {
                return 'VOID';
            }
            
            if (actualNum === lineNum) {
                return 'PUSH';
            }
            
            if (direction?.toLowerCase() === 'over') {
                return actualNum > lineNum ? 'HIT' : 'MISS';
            } else if (direction?.toLowerCase() === 'under') {
                return actualNum < lineNum ? 'HIT' : 'MISS';
            }
            
            return 'VOID';
        }

        function renderGradedResults(slip) {
            const output = document.getElementById('results-output');
            
            // Calculate hit/miss stats
            const hits = slip.events.filter(e => e.result === 'HIT').length;
            const misses = slip.events.filter(e => e.result === 'MISS').length;
            const total = hits + misses; // Only count completed picks
            const hitRate = total > 0 ? ((hits / total) * 100).toFixed(1) : 0;
            
            let html = `
                <div class="slip-container" id="results-to-capture">
                    <div class="slip-header">
                        <div class="slip-header-content">
                            <div class="slip-title">üìä ${slip.slip_id || 'Graded Results'}</div>
                            <div class="slip-meta">
                                üìÖ ${slip.date || 'No date'} | 
                                üèÄ ${slip.sport || 'Multi-Sport'}
                            </div>
                        </div>
                        <div class="slip-branding">$lip$mith</div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-green); margin-bottom: 0.5rem;">
                            ${hits} - ${misses}
                        </div>
                        <div style="font-size: 1rem; color: var(--text-secondary);">
                            Hit Rate: <span style="color: ${hitRate >= 77 ? 'var(--success)' : hitRate >= 65 ? 'var(--warning)' : 'var(--danger)'}; font-weight: bold;">${hitRate}%</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                            (${hits} Hits / ${misses} Misses)
                        </div>
                    </div>
            `;

            slip.events.forEach(ev => {
                const tierBadge = ev.tier ? `<span class="tier-badge-inline tier-${ev.tier}">${ev.tier.toUpperCase()}</span>` : '';
                html += `
                    <div class="event-card">
                        <div class="event-header">
                            <div class="game-info">üèüÔ∏è ${ev.game_id || 'N/A'}${tierBadge}</div>
                            <span class="status-badge badge-${ev.result?.toLowerCase() || 'pending'}">${ev.result || 'PENDING'}</span>
                        </div>
                        <div class="pick-details">
                            <div class="pick-item">
                                <div class="pick-label">Player</div>
                                <div class="pick-value">${ev.player || 'N/A'}</div>
                            </div>
                            <div class="pick-item">
                                <div class="pick-label">Market</div>
                                <div class="pick-value">${formatMarket(ev.market)}</div>
                            </div>
                            <div class="pick-item">
                                <div class="pick-label">Pick</div>
                                <div class="pick-line">${ev.direction?.toUpperCase() || 'N/A'} ${ev.line || 'N/A'}</div>
                            </div>
                            <div class="pick-item">
                                <div class="pick-label">Actual</div>
                                <div class="result-actual">${ev.actual_value !== undefined ? ev.actual_value : 'N/A'}</div>
                            </div>
                        </div>
                        ${ev.reason ? `<div class="result-reason">üìù ${ev.reason}</div>` : ''}
                    </div>
                `;
            });

            html += `</div>`;
            output.innerHTML = html;
        }

        // Render recap (Recap tab)
        function renderRecap() {
            const json = document.getElementById('recap-json').value;
            const output = document.getElementById('recap-output');
            
            try {
                const slip = JSON.parse(json);
                
                // Calculate summary
                const summary = {
                    total: slip.events.length,
                    hit: slip.events.filter(e => e.result === 'HIT').length,
                    miss: slip.events.filter(e => e.result === 'MISS').length,
                    push: slip.events.filter(e => e.result === 'PUSH').length,
                    void: slip.events.filter(e => e.result === 'VOID').length,
                    pending: slip.events.filter(e => e.result === 'PENDING').length
                };
                
                const hitTotal = summary.hit + summary.miss;
                const hitRate = hitTotal > 0 ? ((summary.hit / hitTotal) * 100).toFixed(1) : 0;

                let html = `
                    <div class="recap-container" id="recap-to-capture">
                        <div class="slip-header">
                            <div class="slip-header-content">
                                <div class="slip-title">üìã ${slip.slip_id || 'Recap Sheet'}</div>
                                <div class="slip-meta">üìÖ ${slip.date || 'No date'}</div>
                            </div>
                            <div class="slip-branding">$lip$mith</div>
                        </div>
                        
                        <div class="recap-summary">
                            <div class="summary-item">
                                <div class="summary-label">Total</div>
                                <div class="summary-value">${summary.total}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">‚úÖ Hit</div>
                                <div class="summary-value" style="color: var(--success);">${summary.hit}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">‚ùå Miss</div>
                                <div class="summary-value" style="color: var(--danger);">${summary.miss}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Hit Rate</div>
                                <div class="summary-value" style="color: ${hitRate >= 77 ? 'var(--success)' : hitRate >= 65 ? 'var(--warning)' : 'var(--danger)'};">${hitRate}%</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">‚öñÔ∏è Push</div>
                                <div class="summary-value" style="color: var(--warning);">${summary.push}</div>
                            </div>
                            ${summary.void > 0 ? `
                            <div class="summary-item">
                                <div class="summary-label">‚ö´ Void</div>
                                <div class="summary-value" style="color: var(--text-muted);">${summary.void}</div>
                            </div>
                            ` : ''}
                        </div>
                `;

                slip.events.forEach(ev => {
                    const tierBadge = ev.tier ? `<span class="tier-badge-inline tier-${ev.tier}">${ev.tier.toUpperCase()}</span>` : '';
                    const reasoning = ev.reasoning ? `<div class="pick-reasoning">üí° ${ev.reasoning}</div>` : '';
                    
                    html += `
                        <div class="event-card">
                            <div class="event-header">
                                <div class="game-info">${ev.player || 'N/A'} - ${formatMarket(ev.market)}${tierBadge}</div>
                                <span class="status-badge badge-${ev.result?.toLowerCase() || 'void'}">${ev.result || 'VOID'}</span>
                            </div>
                            <div class="pick-details">
                                <div class="pick-item">
                                    <div class="pick-label">Line</div>
                                    <div class="pick-line">${ev.direction?.toUpperCase() || 'N/A'} ${ev.line || 'N/A'}</div>
                                </div>
                                <div class="pick-item">
                                    <div class="pick-label">Actual</div>
                                    <div class="result-actual">${ev.actual_value !== undefined ? ev.actual_value : 'N/A'}</div>
                                </div>
                            </div>
                            ${reasoning}
                            ${ev.reason ? `<div class="result-reason">üìù ${ev.reason}</div>` : ''}
                        </div>
                    `;
                });

                html += `</div>`;
                output.innerHTML = html;
                showMessage('success', 'Recap rendered successfully!');
                updateRecapPostButton();
                
            } catch (e) {
                output.innerHTML = `<div class="error-message">‚ùå Error: ${e.message}</div>`;
                updateRecapPostButton();
            }
        }

        // API Integration Functions

        // NBA - balldontlie.io
        async function fetchNBAStats(event, date) {
            try {
                // Note: balldontlie API v1 may require different approach
                // This is a placeholder implementation showing the structure
                const cacheKey = `${event.player}_${date}_${event.market}`;
                
                if (apiCache.nba.has(cacheKey)) {
                    return apiCache.nba.get(cacheKey);
                }

                // Mock data for demonstration
                const result = {
                    value: Math.floor(Math.random() * 40),
                    reason: `Mock data - Live API integration pending`
                };
                
                apiCache.nba.set(cacheKey, result);
                return result;
                
            } catch (e) {
                return { error: `NBA API error: ${e.message}` };
            }
        }

        // NHL - statsapi.web.nhl.com
        async function fetchNHLStats(event, date) {
            try {
                const cacheKey = `${event.game_id}_${event.player}`;
                
                if (apiCache.nhl.has(cacheKey)) {
                    return apiCache.nhl.get(cacheKey);
                }

                // Mock data for demonstration
                const result = {
                    value: Math.floor(Math.random() * 3),
                    reason: `Mock data - Live API integration pending`
                };
                
                apiCache.nhl.set(cacheKey, result);
                return result;
                
            } catch (e) {
                return { error: `NHL API error: ${e.message}. Possible CORS issue.` };
            }
        }

        // NFL - ESPN API
        async function fetchNFLStats(event, date) {
            try {
                const cacheKey = `${event.game_id}_${event.player}_${event.market}`;
                
                if (apiCache.nfl.has(cacheKey)) {
                    return apiCache.nfl.get(cacheKey);
                }

                // Parse game_id to get teams
                const teams = event.game_id.split('@');
                if (teams.length !== 2) {
                    return { error: 'Invalid game_id format. Use VIS@HOME format.' };
                }

                // Mock data for demonstration
                const result = {
                    value: Math.floor(Math.random() * 300),
                    reason: `Mock data - Live API integration pending`
                };
                
                apiCache.nfl.set(cacheKey, result);
                return result;
                
            } catch (e) {
                return { error: `NFL API error: ${e.message}. ESPN API may have CORS restrictions.` };
            }
        }

        // Soccer - ESPN API
        async function fetchSoccerStats(event, date) {
            try {
                const cacheKey = `${event.game_id}_${event.player}_${event.market}`;
                
                if (apiCache.soccer.has(cacheKey)) {
                    return apiCache.soccer.get(cacheKey);
                }

                // Mock data for demonstration
                const result = {
                    value: Math.floor(Math.random() * 3),
                    reason: `Mock data - Live API integration pending`
                };
                
                apiCache.soccer.set(cacheKey, result);
                return result;
                
            } catch (e) {
                return { error: `Soccer API error: ${e.message}. ESPN API may have CORS restrictions.` };
            }
        }

        // Utility functions
        function showMessage(type, message) {
            const existingMessages = document.querySelectorAll('.success-message, .error-message');
            existingMessages.forEach(msg => msg.remove());
            
            const msgDiv = document.createElement('div');
            msgDiv.className = type === 'success' ? 'success-message' : 'error-message';
            msgDiv.textContent = message;
            
            const activeTab = document.querySelector('.tab-content.active');
            const controls = activeTab.querySelector('.controls');
            controls.appendChild(msgDiv);
            
            setTimeout(() => msgDiv.remove(), 5000);
        }

        // Image generation functions
        async function generateImage() {
            const element = document.getElementById('slip-to-capture');
            if (!element) {
                showMessage('error', 'Please render the slip first!');
                return;
            }
            
            try {
                showMessage('success', 'Generating image...');
                const canvas = await html2canvas(element, {
                    backgroundColor: '#0a0e0f',
                    scale: 2
                });
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `slip-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessage('success', 'Image downloaded!');
                });
            } catch (e) {
                showMessage('error', 'Error generating image: ' + e.message);
            }
        }
        
        async function generateRecapImage() {
            const element = document.getElementById('recap-to-capture');
            if (!element) {
                showMessage('error', 'Please render the recap first!');
                return;
            }
            
            try {
                showMessage('success', 'Generating image...');
                const canvas = await html2canvas(element, {
                    backgroundColor: '#0a0e0f',
                    scale: 2
                });
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recap-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessage('success', 'Image downloaded!');
                });
            } catch (e) {
                showMessage('error', 'Error generating image: ' + e.message);
            }
        }

        // Post to Feed functionality
        let currentPostType = 'slip'; // 'slip' or 'recap'
        let currentRenderedHTML = null;
        
        function postToFeed() {
            if (!currentSlipData) {
                showMessage('error', 'Please render a slip first!');
                return;
            }
            
            currentPostType = 'slip';
            
            // Pre-fill the tier from the tier selector
            const selectedTier = document.getElementById('tier-select').value;
            document.getElementById('feed-post-tier').value = selectedTier;
            
            // Suggest a title
            const slipId = currentSlipData.slip_id || 'Slip';
            const sport = currentSlipData.sport || 'Multi-Sport';
            const date = currentSlipData.date || new Date().toISOString().split('T')[0];
            document.getElementById('feed-post-title').value = `${sport} ${slipId} - ${date}`;
            
            // Show modal
            document.getElementById('post-to-feed-modal').style.display = 'block';
        }
        
        function postRecapToFeed() {
            const recapOutput = document.getElementById('recap-output');
            if (!recapOutput.innerHTML || recapOutput.innerHTML.trim() === '') {
                showMessage('error', 'Please render a recap first!');
                return;
            }
            
            currentPostType = 'recap';
            
            // Try to get data from recap JSON
            try {
                const json = document.getElementById('recap-json').value;
                const data = JSON.parse(json);
                
                // Pre-fill tier if available
                if (data.tier) {
                    document.getElementById('feed-post-tier').value = data.tier;
                }
                
                // Suggest a title
                const slipId = data.slip_id || 'Recap';
                const sport = data.sport || 'Multi-Sport';
                const date = data.date || new Date().toISOString().split('T')[0];
                document.getElementById('feed-post-title').value = `${sport} ${slipId} Results - ${date}`;
            } catch (e) {
                // If can't parse, just use defaults
                document.getElementById('feed-post-title').value = `Recap - ${new Date().toISOString().split('T')[0]}`;
            }
            
            // Show modal
            document.getElementById('post-to-feed-modal').style.display = 'block';
        }
        
        function closePostModal() {
            document.getElementById('post-to-feed-modal').style.display = 'none';
            document.getElementById('post-modal-status').style.display = 'none';
        }
        
        async function confirmPostToFeed() {
            const title = document.getElementById('feed-post-title').value.trim();
            const description = document.getElementById('feed-post-description').value.trim();
            const minTier = document.getElementById('feed-post-tier').value;
            const statusDiv = document.getElementById('post-modal-status');
            const confirmBtn = document.getElementById('confirm-post-btn');
            
            if (!title) {
                statusDiv.innerHTML = '<div style="color: var(--danger); padding: 0.75rem; background: rgba(255, 68, 68, 0.1); border-radius: 8px;">Please enter a title</div>';
                statusDiv.style.display = 'block';
                return;
            }
            
            // Check if Firebase is available
            if (typeof window.createPost !== 'function') {
                statusDiv.innerHTML = '<div style="color: var(--danger); padding: 0.75rem; background: rgba(255, 68, 68, 0.1); border-radius: 8px;">Firebase not loaded. Please open this tool from the admin dashboard.</div>';
                statusDiv.style.display = 'block';
                return;
            }
            
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Posting...';
            statusDiv.style.display = 'none';
            
            try {
                // Capture the rendered content as an image
                const elementId = currentPostType === 'slip' ? 'slip-to-capture' : 'recap-to-capture';
                const element = document.getElementById(elementId);
                
                if (!element) {
                    throw new Error('No rendered content found. Please render first.');
                }
                
                statusDiv.innerHTML = '<div style="color: var(--accent-green); padding: 0.75rem; background: rgba(0, 255, 136, 0.1); border-radius: 8px;">üì∏ Generating image...</div>';
                statusDiv.style.display = 'block';
                
                // Generate image using html2canvas
                const canvas = await html2canvas(element, {
                    backgroundColor: '#0a0e0f',
                    scale: 2
                });
                
                // Convert canvas to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                statusDiv.innerHTML = '<div style="color: var(--accent-green); padding: 0.75rem; background: rgba(0, 255, 136, 0.1); border-radius: 8px;">‚òÅÔ∏è Uploading image...</div>';
                
                // Upload the image
                const file = new File([blob], `${currentPostType}-${Date.now()}.png`, { type: 'image/png' });
                const mediaData = await window.uploadMedia(file);
                
                statusDiv.innerHTML = '<div style="color: var(--accent-green); padding: 0.75rem; background: rgba(0, 255, 136, 0.1); border-radius: 8px;">üìù Creating post...</div>';
                
                // Create the post with bot metadata
                const postData = {
                    title: title,
                    content: description || `${currentPostType === 'slip' ? 'üéØ Morning Slip' : 'üìä Results Recap'}`,
                    minTier: minTier,
                    mediaUrl: mediaData.url,
                    mediaType: 'image/png',
                    authorName: 'Slipsmith Bot',
                    authorType: 'bot',
                    source: 'Slipsmith Bot'
                };
                
                await window.createPost(postData);
                
                statusDiv.innerHTML = '<div style="color: var(--accent-green); padding: 0.75rem; background: rgba(0, 255, 136, 0.1); border-radius: 8px; font-weight: 600;">‚úÖ Successfully posted to content feed!</div>';
                statusDiv.style.display = 'block';
                
                // Reset form and close after 2 seconds
                setTimeout(() => {
                    closePostModal();
                    document.getElementById('feed-post-title').value = '';
                    document.getElementById('feed-post-description').value = '';
                }, 2000);
                
            } catch (error) {
                console.error('Error posting to feed:', error);
                statusDiv.innerHTML = `<div style="color: var(--danger); padding: 0.75rem; background: rgba(255, 68, 68, 0.1); border-radius: 8px;">‚ùå Error: ${error.message}</div>`;
                statusDiv.style.display = 'block';
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Post to Feed';
            }
        }
        
        // Show/hide Post to Feed button based on whether content is rendered
        function updatePostToFeedButton() {
            const slipOutput = document.getElementById('slip-output');
            const postBtn = document.getElementById('post-to-feed-btn');
            
            if (slipOutput.innerHTML && slipOutput.innerHTML.trim() !== '') {
                postBtn.style.display = 'inline-block';
            } else {
                postBtn.style.display = 'none';
            }
        }
        
        function updateRecapPostButton() {
            const recapOutput = document.getElementById('recap-output');
            const postBtn = document.getElementById('post-recap-to-feed-btn');
            
            if (recapOutput.innerHTML && recapOutput.innerHTML.trim() !== '') {
                postBtn.style.display = 'inline-block';
            } else {
                postBtn.style.display = 'none';
            }
        }

        // Initialize
        console.log('THE Slipsmith loaded successfully!');
        console.log('üéØ Enhanced with probability, reasoning, tier limits, image generation, and post to feed!');
    </script>
</body>
</html>
