<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - $lip$mith</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">$lip$mith</div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="plans.html">Plans</a></li>
                <li><a href="portal.html">Portal</a></li>
                <li><a href="inbox.html" id="inbox-link" class="hidden nav-item">Inbox<span class="nav-pill-alert" id="nav-inbox-alert-pill"></span></a></li>
                <li><a href="account.html" id="account-link" class="hidden">Account</a></li>
                <li><a href="admin.html" class="active" id="admin-link">Admin</a></li>
                <li><button id="logout-button" class="btn btn-primary hidden">Log Out</button></li>
            </ul>
        </div>
    </nav>

    <main>
        <section class="admin-section">
            <div class="container">
                <div id="auth-required" class="auth-notice">
                    <h2>ðŸ”’ Admin Access Required</h2>
                    <p>You must be logged in as an admin to access this page.</p>
                    <a href="login.html" class="btn btn-primary">Login</a>
                </div>

                <div id="admin-content" style="display: none;">
                    <h1>Admin Dashboard</h1>
                    
                    <div class="admin-tabs">
                        <button class="tab-btn active" data-tab="posts">Manage Posts</button>
                        <button class="tab-btn" data-tab="users">Manage Users</button>
                        <button class="tab-btn" data-tab="slip-requests">Slip Requests</button>
                        <button class="tab-btn" data-tab="feed-manager">Sports Feed</button>
                        <button class="tab-btn" data-tab="user-manager">Admin User Manager</button>
                        <button class="tab-btn" data-tab="slip-tools">Slip Tools</button>
                    </div>

                    <!-- Posts Management Tab -->
                    <div id="posts-tab" class="tab-content active">
                        <div class="admin-grid">
                            <!-- Create/Edit Post Form -->
                            <div class="admin-card">
                                <h2 id="post-form-title">Create New Post</h2>
                                <form id="post-form" class="admin-form">
                                    <input type="hidden" id="post-id">
                                    
                                    <div class="form-group">
                                        <label for="post-title">Title *</label>
                                        <input type="text" id="post-title" required placeholder="Post title">
                                    </div>

                                    <div class="form-group">
                                        <label for="post-content">Content *</label>
                                        <textarea id="post-content" rows="6" required placeholder="Post content"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label for="post-tier">Minimum Tier *</label>
                                        <select id="post-tier" required>
                                            <option value="starter">Starter</option>
                                            <option value="pro">Pro</option>
                                            <option value="vip">VIP</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="post-media">Upload Media (optional)</label>
                                        <input type="file" id="post-media" accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
                                        <button type="button" id="post-media-button" class="btn btn-outline btn-sm">ðŸ“Ž Choose File</button>
                                        <span id="post-media-filename" style="margin-left: 0.5rem; color: var(--text-secondary);"></span>
                                        <small class="form-hint">Images, videos, or documents</small>
                                    </div>

                                    <div id="current-media" class="current-media" style="display: none;">
                                        <p>Current media: <span id="media-name"></span></p>
                                        <button type="button" class="btn btn-sm btn-outline" id="remove-media">Remove</button>
                                    </div>

                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="post-as-bot">
                                            Post as Slipsmith Bot
                                        </label>
                                        <small class="form-hint">Check this to post content as the Slipsmith Bot instead of a regular admin post</small>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary" id="save-post-btn">
                                            <span class="btn-text">Create Post</span>
                                            <span class="btn-loading" style="display: none;">Saving...</span>
                                        </button>
                                        <button type="button" class="btn btn-outline" id="cancel-post-btn" style="display: none;">Cancel</button>
                                    </div>

                                    <div id="post-form-error" class="error-message" style="display: none;"></div>
                                    <div id="post-form-success" class="success-message" style="display: none;"></div>
                                </form>
                            </div>

                            <!-- Posts List -->
                            <div class="admin-card">
                                <h2>All Posts</h2>
                                <div id="posts-list" class="admin-list">
                                    <div class="loading">Loading posts...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Management Tab -->
                    <div id="users-tab" class="tab-content">
                        <div class="admin-card">
                            <h2>User Management</h2>
                            <div class="filter-controls">
                                <select id="tier-filter" class="filter-select">
                                    <option value="all">All Tiers</option>
                                    <option value="starter">Starter</option>
                                    <option value="pro">Pro</option>
                                    <option value="vip">VIP</option>
                                </select>
                            </div>
                            <div id="users-list" class="admin-list">
                                <div class="loading">Loading users...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Slip Requests Tab -->
                    <div id="slip-requests-tab" class="tab-content">
                        <div class="admin-card">
                            <h2>Slip Requests</h2>
                            
                            <!-- Filter Controls -->
                            <div class="admin-filters">
                                <div class="filter-group">
                                    <label for="filter-tier">Filter by Tier:</label>
                                    <select id="filter-tier" class="filter-select">
                                        <option value="all">All Tiers</option>
                                        <option value="pro">Pro</option>
                                        <option value="vip">VIP</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label for="filter-sport">Filter by Sport:</label>
                                    <select id="filter-sport" class="filter-select">
                                        <option value="all">All Sports</option>
                                        <option value="NBA">NBA</option>
                                        <option value="NFL">NFL</option>
                                        <option value="NHL">NHL</option>
                                        <option value="MLB">MLB</option>
                                        <option value="UCL">UCL</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label for="filter-status">Filter by Status:</label>
                                    <select id="filter-status" class="filter-select">
                                        <option value="all">All Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="answered">Answered</option>
                                        <option value="declined">Declined</option>
                                    </select>
                                </div>
                                
                                <button id="clear-filters" class="btn btn-outline btn-sm">Clear Filters</button>
                            </div>
                            
                            <div id="admin-slip-requests-list"></div>
                        </div>
                    </div>

                    <!-- Admin User Manager Tab -->
                    <div id="user-manager-tab" class="tab-content">
                        <div class="admin-card">
                            <h2>Admin User Manager</h2>
                            <p>Use this form to create or update user accounts.</p>

                            <form id="admin-user-form" class="admin-form">
                                <div class="form-group">
                                    <label for="admin-user-uid">User UID (leave blank to create new)</label>
                                    <input type="text" id="admin-user-uid" placeholder="Existing user UID (optional)">
                                </div>

                                <div class="form-group">
                                    <label for="admin-user-email">Email *</label>
                                    <input type="email" id="admin-user-email" required placeholder="user@example.com">
                                </div>

                                <div class="form-group">
                                    <label for="admin-user-username">Username (optional)</label>
                                    <input type="text" id="admin-user-username" placeholder="Username">
                                </div>

                                <div class="form-group">
                                    <label for="admin-user-role">Role *</label>
                                    <select id="admin-user-role" required>
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="admin-user-tier">Tier *</label>
                                    <select id="admin-user-tier" required>
                                        <option value="starter">Starter</option>
                                        <option value="pro">Pro</option>
                                        <option value="vip">VIP</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="admin-user-subscription-ends">Subscription Ends At (optional)</label>
                                    <input type="datetime-local" id="admin-user-subscription-ends" placeholder="Select date and time">
                                    <small class="form-hint">Leave blank for no expiration. Sets when the user's subscription expires.</small>
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="admin-user-must-change-password">
                                        Require password change on first login
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label for="admin-user-temp-password">Temporary password (leave blank to auto-generate)</label>
                                    <input type="text" id="admin-user-temp-password" placeholder="Leave blank for auto-generation">
                                </div>

                                <button type="submit" class="btn btn-primary" id="admin-user-submit-button">Create / Update User</button>

                                <div id="admin-user-status" class="success-message" style="display: none;"></div>
                                <div id="admin-user-temp-password-display" class="success-message" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--primary); border-radius: 4px;"></div>
                            </form>
                        </div>
                    </div>

                    <!-- Slip Tools Tab -->
                    <!-- Feed Manager Tab -->
                    <div id="feed-manager-tab" class="tab-content">
                        <div class="admin-card">
                            <h2>ðŸ”´ Sports Feed Manager</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Manage the Live Sports Feed visible on the portal</p>
                            
                            <div style="display: grid; gap: 1.5rem; margin-bottom: 2rem;">
                                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--accent-green);">
                                    <h3 style="color: var(--accent-green); margin-bottom: 0.5rem;">ðŸŽ² Load Sample Feed Data</h3>
                                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                        Quickly populate the sports feed with sample injury reports, suspensions, and news items for testing.
                                    </p>
                                    <button onclick="loadSampleFeedData()" class="btn btn-primary" id="load-sample-btn">
                                        Load 10 Sample Items
                                    </button>
                                    <button onclick="clearSampleFeedData()" class="btn btn-outline" style="margin-left: 0.5rem;">
                                        Clear Sample Data
                                    </button>
                                    <div id="feed-sample-status" style="margin-top: 1rem;"></div>
                                </div>

                                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">âž• Add Custom Feed Item</h3>
                                    <form id="custom-feed-form" style="display: grid; gap: 1rem;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Sport</label>
                                            <select id="feed-sport" class="form-control" required>
                                                <option value="NBA">NBA</option>
                                                <option value="NFL">NFL</option>
                                                <option value="NHL">NHL</option>
                                                <option value="MLB">MLB</option>
                                                <option value="UCL">UCL</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Type</label>
                                            <select id="feed-type" class="form-control" required>
                                                <option value="injury">Injury</option>
                                                <option value="suspension">Suspension</option>
                                                <option value="news">News</option>
                                                <option value="line_movement">Line Movement</option>
                                                <option value="depth_chart">Depth Chart</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Headline</label>
                                            <input type="text" id="feed-headline" class="form-control" placeholder="Player Name - Status" required>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Details</label>
                                            <textarea id="feed-details" class="form-control" rows="2" placeholder="Additional details..."></textarea>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div>
                                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Player (optional)</label>
                                                <input type="text" id="feed-player" class="form-control" placeholder="Player name">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Team (optional)</label>
                                                <input type="text" id="feed-team" class="form-control" placeholder="Team name">
                                            </div>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">URL (optional)</label>
                                            <input type="url" id="feed-url" class="form-control" placeholder="https://...">
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Feed Item</button>
                                        <div id="feed-custom-status"></div>
                                    </form>
                                </div>

                                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">ðŸ“Š API Integration</h3>
                                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                        Set up automated sports news fetching using Firebase Cloud Functions. See documentation for details.
                                    </p>
                                    <a href="../SPORTS_API_INTEGRATION.md" class="btn btn-outline" target="_blank">View Integration Guide</a>
                                    <a href="../functions-example/README.md" class="btn btn-outline" target="_blank" style="margin-left: 0.5rem;">Cloud Functions Setup</a>
                                </div>
                            </div>

                            <div>
                                <h3 style="margin-bottom: 1rem;">Current Feed Items</h3>
                                <div id="feed-items-list" style="display: flex; flex-direction: column; gap: 1rem; max-height: 500px; overflow-y: auto;">
                                    <p style="color: var(--text-muted);">Loading feed items...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="slip-tools-tab" class="tab-content">
                        <div class="admin-card">
                            <h2>ðŸŽ¯ Slip Tools</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Professional slip rendering and results grading tools</p>
                            
                            <div style="display: grid; gap: 1.5rem;">
                                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--accent-green);">
                                    <h3 style="color: var(--accent-green); margin-bottom: 0.5rem;">THE Slipsmith</h3>
                                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                        Complete tool for rendering slips, grading picks with live stats, generating recap sheets, and creating shareable images.
                                    </p>
                                    <a href="admin/the-slipsmith.html" class="btn btn-primary" target="_blank">Open THE Slipsmith</a>
                                </div>

                                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">ðŸ“– Documentation</h3>
                                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                        Learn about the slip JSON schema, supported sports APIs, and usage instructions.
                                    </p>
                                    <a href="admin/README.md" class="btn btn-outline" target="_blank">View README</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 $lip$mith. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase SDKs (v9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <!-- My Firebase initialization -->
    <script src="firebase.js"></script>

    <!-- Main app logic -->
    <script src="app.js"></script>
    <script>
        let editingPostId = null;

        // Initialize admin panel
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const user = await getCurrentUser();
                if (user) {
                    // Use the isAdmin helper from app.js to check admin status
                    const adminStatus = await isAdmin(user.uid);
                    const userData = await getUserData(user.uid);
                    
                    // Debug logging for admin access
                    console.log('Admin gate:', {
                        uid: user.uid,
                        isAdmin: adminStatus,
                        role: userData?.role,
                        email: userData?.email || user.email
                    });
                    
                    if (adminStatus) {
                        showAdminContent();
                    } else {
                        showAuthRequired();
                    }
                } else {
                    console.log('Admin gate: No user authenticated');
                    showAuthRequired();
                }
            } catch (error) {
                console.error('Admin initialization error:', error);
                showAuthRequired();
            }
        });

        async function showAuthRequired() {
            const authRequiredDiv = document.getElementById('auth-required');
            
            // Get current user from app.js globals or fetch it
            const user = await getCurrentUser();
            const userData = user ? await getUserData(user.uid) : null;
            
            // If user is logged in but not admin, show detailed message
            if (user && userData) {
                const userEmail = userData.email || user.email || 'Unknown';
                const userRole = userData.role || 'none';
                
                authRequiredDiv.innerHTML = `
                    <h2>ðŸš« Admin Access Denied</h2>
                    <p><strong>You are logged in as:</strong> ${userEmail}</p>
                    <p><strong>Your current role:</strong> ${userRole}</p>
                    <p class="error-message">This account does not have admin privileges.</p>
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; text-align: left;">
                        <h3 style="margin-top: 0;">To gain admin access:</h3>
                        <ol style="margin: 0.5rem 0;">
                            <li>Contact your site administrator</li>
                            <li>Or update your user document in Firestore:
                                <ul style="margin-top: 0.5rem;">
                                    <li>Go to Firebase Console â†’ Firestore Database</li>
                                    <li>Navigate to collection: <code>users</code></li>
                                    <li>Find document with ID: <code>${user.uid}</code></li>
                                    <li>Add or update field: <code>role</code> = <code>"admin"</code></li>
                                    <li>Refresh this page</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                        <a href="portal.html" class="btn btn-primary">Go to Portal</a>
                        <button id="logout-btn-denied" class="btn btn-outline">Log Out</button>
                    </div>
                `;
                
                // Add logout handler for the new button
                document.getElementById('logout-btn-denied')?.addEventListener('click', async () => {
                    try {
                        await logoutUser();
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                });
            }
            
            authRequiredDiv.style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
        }

        function showAdminContent() {
            document.getElementById('auth-required').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            loadPosts();
            loadUsers();
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`${tab}-tab`).classList.add('active');
            });
        });

        // Load all posts
        async function loadPosts() {
            const container = document.getElementById('posts-list');
            try {
                const posts = await getAllPosts();
                
                if (posts.length === 0) {
                    container.innerHTML = '<p class="no-content">No posts yet.</p>';
                    return;
                }

                container.innerHTML = posts.map(post => `
                    <div class="admin-item">
                        <div class="item-content">
                            <h3>${post.title}</h3>
                            <p>${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>
                            <div class="item-meta">
                                <span class="tier-badge tier-${post.minTier}">${post.minTier.toUpperCase()}</span>
                                <span>ðŸ“… ${new Date(post.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-outline" onclick="editPost('${post.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePost('${post.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<p class="error">Error loading posts.</p>';
            }
        }

        // Load all users
        async function loadUsers() {
            const container = document.getElementById('users-list');
            try {
                const users = await getAllUsers();
                displayUsers(users);
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<p class="error">Error loading users.</p>';
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('users-list');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="no-content">No users yet.</p>';
                return;
            }

            container.innerHTML = users.map(user => {
                // Handle Firebase Timestamp conversion
                let joinedDate = 'Unknown';
                if (user.createdAt) {
                    try {
                        // Check if it's a Firebase Timestamp object with toDate() method
                        if (user.createdAt.toDate && typeof user.createdAt.toDate === 'function') {
                            joinedDate = user.createdAt.toDate().toLocaleDateString();
                        } 
                        // Check if it's already a number (milliseconds)
                        else if (typeof user.createdAt === 'number') {
                            joinedDate = new Date(user.createdAt).toLocaleDateString();
                        }
                        // Try converting to Date directly
                        else {
                            joinedDate = new Date(user.createdAt).toLocaleDateString();
                        }
                    } catch (e) {
                        console.error('Error converting createdAt date:', e, user.createdAt);
                        joinedDate = 'Invalid Date';
                    }
                }
                
                return `
                    <div class="admin-item">
                        <div class="item-content">
                            <h3>${user.email}</h3>
                            <div class="item-meta">
                                <span class="tier-badge tier-${user.tier}">${user.tier.toUpperCase()}</span>
                                ${user.role === 'admin' ? '<span class="badge-admin">ADMIN</span>' : ''}
                                <span>ðŸ“… Joined ${joinedDate}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <select onchange="updateUserTier('${user.uid}', this.value)" class="tier-select">
                                <option value="starter" ${user.tier === 'starter' ? 'selected' : ''}>Starter</option>
                                <option value="pro" ${user.tier === 'pro' ? 'selected' : ''}>Pro</option>
                                <option value="vip" ${user.tier === 'vip' ? 'selected' : ''}>VIP</option>
                            </select>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter users by tier
        document.getElementById('tier-filter').addEventListener('change', async (e) => {
            const tier = e.target.value;
            const users = await getAllUsers();
            const filtered = tier === 'all' ? users : users.filter(u => u.tier === tier);
            displayUsers(filtered);
        });

        // Post form submission
        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await savePost();
        });

        async function savePost() {
            const postId = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const minTier = document.getElementById('post-tier').value;
            const mediaFile = document.getElementById('post-media').files[0];
            const postAsBot = document.getElementById('post-as-bot').checked;
            
            const btn = document.getElementById('save-post-btn');
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');
            const errorDiv = document.getElementById('post-form-error');
            const successDiv = document.getElementById('post-form-success');

            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            btn.disabled = true;

            try {
                const postData = { title, content, minTier };

                // Add bot metadata if posting as bot
                if (postAsBot) {
                    postData.authorName = 'Slipsmith Bot';
                    postData.authorType = 'bot';
                    postData.source = 'Slipsmith Bot';
                }

                // Upload media if provided
                if (mediaFile) {
                    const mediaData = await uploadMedia(mediaFile);
                    postData.mediaUrl = mediaData.url;
                    postData.mediaType = mediaFile.type;
                }

                if (postId) {
                    await updatePost(postId, postData);
                    successDiv.textContent = 'Post updated successfully!';
                } else {
                    await createPost(postData);
                    successDiv.textContent = 'Post created successfully!';
                }

                successDiv.style.display = 'block';
                resetPostForm();
                loadPosts();
            } catch (error) {
                console.error('Error saving post:', error);
                errorDiv.textContent = 'Error saving post: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                btn.disabled = false;
            }
        }

        function resetPostForm() {
            document.getElementById('post-form').reset();
            document.getElementById('post-id').value = '';
            document.getElementById('post-form-title').textContent = 'Create New Post';
            document.getElementById('save-post-btn').querySelector('.btn-text').textContent = 'Create Post';
            document.getElementById('cancel-post-btn').style.display = 'none';
            document.getElementById('current-media').style.display = 'none';
            document.getElementById('post-media-filename').textContent = '';
            editingPostId = null;
        }

        window.editPost = async function(postId) {
            try {
                const post = await getPost(postId);
                editingPostId = postId;
                
                document.getElementById('post-id').value = postId;
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-content').value = post.content;
                document.getElementById('post-tier').value = post.minTier;
                
                document.getElementById('post-form-title').textContent = 'Edit Post';
                document.getElementById('save-post-btn').querySelector('.btn-text').textContent = 'Update Post';
                document.getElementById('cancel-post-btn').style.display = 'inline-block';

                if (post.mediaUrl) {
                    document.getElementById('current-media').style.display = 'block';
                    document.getElementById('media-name').textContent = 'Current file';
                }

                // Scroll to form
                document.getElementById('post-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading post:', error);
                alert('Error loading post for editing.');
            }
        };

        window.deletePost = async function(postId) {
            if (!confirm('Are you sure you want to delete this post?')) return;
            
            try {
                await removePost(postId);
                loadPosts();
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Error deleting post.');
            }
        };

        window.updateUserTier = async function(userId, newTier) {
            try {
                await setUserTier(userId, newTier);
                alert('User tier updated successfully!');
            } catch (error) {
                console.error('Error updating user tier:', error);
                alert('Error updating user tier.');
            }
        };

        document.getElementById('cancel-post-btn').addEventListener('click', resetPostForm);

        document.getElementById('remove-media').addEventListener('click', () => {
            document.getElementById('current-media').style.display = 'none';
            // Note: Actual media deletion would be handled on save
        });

        // Handle post media file upload button
        const postMediaButton = document.getElementById('post-media-button');
        const postMediaInput = document.getElementById('post-media');
        const postMediaFilename = document.getElementById('post-media-filename');
        
        if (postMediaButton && postMediaInput) {
            postMediaButton.addEventListener('click', () => {
                postMediaInput.click();
            });
            
            postMediaInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    postMediaFilename.textContent = file.name;
                } else {
                    postMediaFilename.textContent = '';
                }
            });
        }

        // Logout handler
        document.getElementById('logout-button').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await logoutUser();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // ==========================================================================
        // FEED MANAGEMENT FUNCTIONS
        // ==========================================================================

        async function loadSampleFeedData() {
            const statusDiv = document.getElementById('feed-sample-status');
            const button = document.getElementById('load-sample-btn');
            
            button.disabled = true;
            button.textContent = 'Loading...';
            statusDiv.textContent = '';
            
            const sampleData = [
                {
                    sport: 'NBA',
                    type: 'injury',
                    headline: 'LeBron James - Questionable',
                    details: 'Left ankle soreness. Day-to-day, questionable for next game.',
                    player: 'LeBron James',
                    team: 'Los Angeles Lakers',
                    publishedAt: new Date(Date.now() - 2 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/nba/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'NFL',
                    type: 'injury',
                    headline: 'Patrick Mahomes - Out',
                    details: 'High ankle sprain. Ruled out for Sunday\'s game.',
                    player: 'Patrick Mahomes',
                    team: 'Kansas City Chiefs',
                    publishedAt: new Date(Date.now() - 5 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/nfl/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'NBA',
                    type: 'suspension',
                    headline: 'Draymond Green - Suspended 5 Games',
                    details: 'Suspended for flagrant foul. Will miss games against Nuggets, Suns, and Clippers.',
                    player: 'Draymond Green',
                    team: 'Golden State Warriors',
                    publishedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/nba/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'MLB',
                    type: 'news',
                    headline: 'Yankees Sign Star Pitcher',
                    details: 'New York Yankees sign ace pitcher to 5-year, $150M deal.',
                    team: 'New York Yankees',
                    publishedAt: new Date(Date.now() - 3 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/mlb/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'NHL',
                    type: 'injury',
                    headline: 'Connor McDavid - Day to Day',
                    details: 'Upper body injury. Listed as day-to-day.',
                    player: 'Connor McDavid',
                    team: 'Edmonton Oilers',
                    publishedAt: new Date(Date.now() - 6 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/nhl/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'NBA',
                    type: 'news',
                    headline: 'Lakers vs Warriors - Line Movement',
                    details: 'Spread moved from Lakers -3.5 to -5.0 following injury report.',
                    team: 'Los Angeles Lakers',
                    publishedAt: new Date(Date.now() - 30 * 60 * 1000),
                    url: 'https://www.espn.com/nba/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'NFL',
                    type: 'news',
                    headline: 'Bills Release Depth Chart Update',
                    details: 'Starting lineup changes announced. Rookie WR moves to WR2 position.',
                    team: 'Buffalo Bills',
                    publishedAt: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/nfl/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'NBA',
                    type: 'injury',
                    headline: 'Stephen Curry - Probable',
                    details: 'Right shoulder soreness improving. Upgraded to probable.',
                    player: 'Stephen Curry',
                    team: 'Golden State Warriors',
                    publishedAt: new Date(Date.now() - 1 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/nba/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'MLB',
                    type: 'injury',
                    headline: 'Mike Trout - Season Ending Surgery',
                    details: 'Undergoes surgery on torn meniscus. Expected to miss remainder of season.',
                    player: 'Mike Trout',
                    team: 'Los Angeles Angels',
                    publishedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/mlb/',
                    source: 'Manual Sample'
                },
                {
                    sport: 'UCL',
                    type: 'news',
                    headline: 'Manchester United vs Barcelona Preview',
                    details: 'Key matchup in knockout rounds. Both teams at full strength.',
                    team: 'Manchester United',
                    publishedAt: new Date(Date.now() - 12 * 60 * 60 * 1000),
                    url: 'https://www.espn.com/soccer/',
                    source: 'Manual Sample'
                }
            ];
            
            try {
                const batch = db.batch();
                
                for (const item of sampleData) {
                    const docRef = db.collection('feed').doc();
                    batch.set(docRef, {
                        ...item,
                        publishedAt: firebase.firestore.Timestamp.fromDate(item.publishedAt),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
                statusDiv.textContent = `âœ… Successfully added ${sampleData.length} sample feed items!`;
                statusDiv.style.color = 'var(--accent-green)';
                
                // Reload feed items list
                loadFeedItemsList();
            } catch (error) {
                console.error('Error adding sample data:', error);
                statusDiv.textContent = `âŒ Error: ${error.message}`;
                statusDiv.style.color = 'var(--danger)';
            } finally {
                button.disabled = false;
                button.textContent = 'Load 10 Sample Items';
            }
        }

        async function clearSampleFeedData() {
            if (!confirm('Are you sure you want to delete all sample feed data?')) {
                return;
            }
            
            const statusDiv = document.getElementById('feed-sample-status');
            statusDiv.textContent = 'Clearing...';
            
            try {
                const snapshot = await db.collection('feed')
                    .where('source', '==', 'Manual Sample')
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                statusDiv.textContent = `âœ… Deleted ${snapshot.size} sample feed items.`;
                statusDiv.style.color = 'var(--accent-green)';
                
                // Reload feed items list
                loadFeedItemsList();
            } catch (error) {
                console.error('Error clearing sample data:', error);
                statusDiv.textContent = `âŒ Error: ${error.message}`;
                statusDiv.style.color = 'var(--danger)';
            }
        }

        // Custom feed form handler
        const customFeedForm = document.getElementById('custom-feed-form');
        if (customFeedForm) {
            customFeedForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const statusDiv = document.getElementById('feed-custom-status');
                statusDiv.textContent = 'Adding...';
                
                const feedItem = {
                    sport: document.getElementById('feed-sport').value,
                    type: document.getElementById('feed-type').value,
                    headline: document.getElementById('feed-headline').value,
                    details: document.getElementById('feed-details').value || '',
                    player: document.getElementById('feed-player').value || '',
                    team: document.getElementById('feed-team').value || '',
                    url: document.getElementById('feed-url').value || '',
                    publishedAt: firebase.firestore.Timestamp.now(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'Manual Custom'
                };
                
                try {
                    await db.collection('feed').add(feedItem);
                    statusDiv.textContent = 'âœ… Feed item added successfully!';
                    statusDiv.style.color = 'var(--accent-green)';
                    customFeedForm.reset();
                    
                    // Reload feed items list
                    loadFeedItemsList();
                } catch (error) {
                    console.error('Error adding custom item:', error);
                    statusDiv.textContent = `âŒ Error: ${error.message}`;
                    statusDiv.style.color = 'var(--danger)';
                }
            });
        }

        // Load and display current feed items
        async function loadFeedItemsList() {
            const listContainer = document.getElementById('feed-items-list');
            if (!listContainer) return;
            
            try {
                listContainer.innerHTML = '<p style="color: var(--text-muted);">Loading feed items...</p>';
                
                const snapshot = await db.collection('feed')
                    .orderBy('publishedAt', 'desc')
                    .limit(50)
                    .get();
                
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p style="color: var(--text-muted);">No feed items yet.</p>';
                    return;
                }
                
                listContainer.innerHTML = '';
                
                snapshot.docs.forEach(doc => {
                    const item = doc.data();
                    const publishedDate = item.publishedAt?.toDate ? 
                        item.publishedAt.toDate().toLocaleString() : 
                        'Unknown';
                    
                    const div = document.createElement('div');
                    div.style.cssText = `
                        background: var(--bg-tertiary);
                        padding: 1rem;
                        border-radius: 8px;
                        border-left: 4px solid var(--accent-green);
                    `;
                    
                    let borderColor = 'var(--accent-green)';
                    if (item.type === 'injury') borderColor = 'var(--danger)';
                    if (item.type === 'suspension') borderColor = 'var(--warning)';
                    if (item.type === 'news') borderColor = 'var(--info)';
                    div.style.borderLeftColor = borderColor;
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <span style="padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; background: rgba(0, 255, 136, 0.2); color: var(--accent-green);">
                                ${item.sport || 'Sports'}
                            </span>
                            <span style="padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">
                                ${item.type || 'news'}
                            </span>
                        </div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                            ${item.headline || 'No headline'}
                        </div>
                        ${item.details ? `<div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${item.details}</div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                            <span>${publishedDate}</span>
                            <button onclick="deleteFeedItem('${doc.id}')" class="btn btn-sm btn-outline" style="color: var(--danger); border-color: var(--danger);">Delete</button>
                        </div>
                    `;
                    
                    listContainer.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading feed items:', error);
                listContainer.innerHTML = `<p style="color: var(--danger);">Error loading feed items: ${error.message}</p>`;
            }
        }

        async function deleteFeedItem(docId) {
            if (!confirm('Are you sure you want to delete this feed item?')) {
                return;
            }
            
            try {
                await db.collection('feed').doc(docId).delete();
                loadFeedItemsList();
            } catch (error) {
                console.error('Error deleting feed item:', error);
                alert('Failed to delete feed item: ' + error.message);
            }
        }

        // Load feed items when tab is opened
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.getAttribute('data-tab') === 'feed-manager') {
                    loadFeedItemsList();
                }
            });
        });

        // Make functions globally available
        window.loadSampleFeedData = loadSampleFeedData;
        window.clearSampleFeedData = clearSampleFeedData;
        window.deleteFeedItem = deleteFeedItem;
    </script>
</body>
</html>
